{% extends "base.html" %}
{% load static %}

{% block content %} 
<style>
    .dot {
  height: 30px;
  width: 30px;
  background-color: "{{color}}";
  border-radius: 50%;
  display: inline-block;
}
</style>
    <div class="container">
        <div class="row mt-5 justify-content-around">
            <div class="col-5 me-2" style="height:auto;background-color: #F5BDC1; border-radius: 20px;">
                <div class=" text text-center mt-3 " style="color: white;font-size: 40px">
                    <div class="rigthside "><p display-6><u> Step 1</u></p>
                    <p> Take Or Upload a photo of you !</p>
                    </div>
                </div>
                
            </div>
            <div class="col-5 "style="height:auto;background-color: #F5BDC1; border-radius: 20px;">
                <video class="m-auto pt-3"id="video" style="height: 300px;width: 500px; border-radius: 20px;;" autoplay></video>
                <button id="snap">Take Picture</button>
            </div>
        </div>
        <canvas class="d-none" id="canvas" width="500px" height="300px"></canvas>

        <div class="row m-auto pt-2">
            <div class="card4 m-2" style="height:100px; border-radius: 20px; background-color: #F5BDC1;">
                <text class="h2 tex-center mx-auto"> OR upload a picture of your wrist</text>
                <form class="p-2" style="z-index: 1;" method="post" enctype="multipart/form-data" id="file_form">
                    {% csrf_token %}
                    <div class="input-group">
                        <input class="form-control" type="file" id="file" name="file" placeholder="Upload File" />
                        <div class="input-group-append">
                            <button type="submit" class="btn btn-secondary" id="myBtn">Upload</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <div class="row mt-5 ">
            <div class="card4" style="height:auto; border-radius: 50px; background-color: #F5BDC1;">
                    <text class="h3 text-center mx-auto"> Here is your results ! </text>
                    <div class="row m-auto" id="showImg" style="width: 500px;height: 300px;">
                        <!-- <img src="{% static 'debug.jpg' %}"> -->
                    </div>
            </div>
        </div>

        <div class="row mt-5 justify-content-around">
            <div class="col-6 col-sm-4 mt-5 me-5" style="height:auto;background-color: #F5BDC1; border-radius: 20px;"> 
                <div class="text h1" style="color: white; font-size: 30px;">Your skinTone:
                    <div class="h1" id="showWords"></div>
                </div>
                <div class="text h1" style="color: white; font-size: 30px;">Your foundation shade is:
                    <div class="h1" id="showWords"></div>
                    <span class="dot" style='background-color: ;'></span>
                </div>
            </div>
            <div class="col-6 col-sm-4 mt-5 me-5"style="height:auto;background-color: #F5BDC1; border-radius: 20px;">
                <div class="text" style="color: white; font-size: 30px;width: auto;">
                    Your recommedned lipstick shades include : 
                    <div class="h5" id="lipsticks"></div>
                </div>
                
              <div class="w-100 d-none d-md-block"></div>
            </div>

    </div>

{% endblock content %}

{% block javascripts %}
<script>
    navigator.mediaDevices.getUserMedia({ video: true })
    .then(function(stream) {
        var video = document.getElementById("video");
        video.srcObject = stream;
        video.play();
    })
    .catch(function(err) {
        console.log("Error: " + err);
    });

    // Take a snapshot when the "Snap Photo" button is clicked
    document.getElementById("snap").addEventListener("click", function() {
        var canvas = document.getElementById("canvas");
        var context = canvas.getContext("2d");
        context.drawImage(video, 0, 0, 640, 480);
        // Save the image to the computer
        var link = document.createElement('a');
        //link.download = 'statics/input.png';
        link.href = canvas.toDataURL(link)
        //link.src = 'path/to/image.png';
        link.click();
        // console.log(link.href)
        newData = new FormData();
        // newData.append("imgfile", input.files[0]);
        newData.append("file", link.href);
        newData.append("csrfmiddlewaretoken", "{{csrf_token}}");
        const csrftoken = "{{csrf_token}}"

        $.ajax({
            type: 'POST',
            url: 'upload/',
            processData: false,
            contentType: false,
            mimeType: "multipart/form-data",
            data: newData,
            success: function (data) {
                var result = JSON.parse(data)
                console.log(result.foundation)
                console.log(result.fileName)

                // $("#showImg").html("<img src=\"{% static data.displayImg %}\" alt=\"img\">")
                $("#showImg").html('')
                "{% load static %}"
                $("#showImg").html('<img src="'+"{% static 'userview.jpg' %}"+ '" />')
                $("#showWords").text(result.foundation)
                $("#lipsticks").text(result.plts)
                // $("#showImg").html(`'<img src="'+"{% static '${result.fileName}' %}"+ '" />'`)
            },
            error: function () {
                alert("Error!");
            }
          })
    });

    $('#file_form').on('submit', function (e) {
        e.preventDefault();

        var input = document.getElementById('file');
        if (!input) {
          alert("Um, couldn't find the fileinput element.");
        }
        else if (!input.files) {
          alert("This browser doesn't seem to support the `files` property of file inputs.");
        }
        else if (!input.files[0]) {
          alert("Please select a file before clicking 'Upload'");               
        }
        else {

          $("#myBtn").toggle();
          $("#loadingBtn").show();
          $('#file').prop("disabled", true)
        // $('#formDiv').removeClass("position-absolute")

          newData = new FormData();
          newData.append("file", input.files[0]);
          newData.append("csrfmiddlewaretoken", $('input[name=csrfmiddlewaretoken]').val());
          $.ajax({
              type: 'POST',
              url: 'upload/',
              processData: false,
              contentType: false,
              mimeType: "multipart/form-data",
              data: newData,
              success: function (data) {                
                var result = JSON.parse(data)
                console.log(result.foundation)
                console.log(result.fileName)

                // $("#showImg").html("<img src=\"{% static data.displayImg %}\" alt=\"img\">")
                $("#showImg").html('')
                "{% load static %}"
                $("#showImg").html('<img src="'+"{% static 'userview.jpg' %}"+ '" />')
                $("#showWords").text(result.foundation)
                $("#lipsticks").text(result.plts)

                // $("#showImg").html(`'<img src="'+"{% static '${result.fileName}' %}"+ '" />'`)
                
                $("#myBtn").toggle();
                $("#loadingBtn").hide()
                $('#file').prop("disabled", false)
              },
              error: function (data) {
                  alert("Error!"+data);
                  $("#myBtn").toggle();
                  $("#loadingBtn").hide()
                  $('#file').prop("disabled", false)
              }
          })
        }

    })
    

</script>
{% endblock javascripts %}